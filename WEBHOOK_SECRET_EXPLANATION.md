# ะะฐะบ ัะฐะฑะพัะฐะตั Webhook Secret Token

## ๐ ะัะธะฝัะธะฟ ัะฐะฑะพัั

Webhook Secret Token โ ััะพ ะผะตัะฐะฝะธะทะผ ะฑะตะทะพะฟะฐัะฝะพััะธ, ะบะพัะพััะน ะฟะพะทะฒะพะปัะตั ัะฑะตะดะธัััั, ััะพ ะทะฐะฟัะพัั ะดะตะนััะฒะธัะตะปัะฝะพ ะฟัะธัะพะดัั ะพั Telegram, ะฐ ะฝะต ะพั ะทะปะพัะผััะปะตะฝะฝะธะบะพะฒ.

### ะะฐะบ ััะพ ัะฐะฑะพัะฐะตั:

1. **ะัะธ ะฝะฐัััะพะนะบะต webhook ะฒ Telegram** ะฒั ัะบะฐะทัะฒะฐะตัะต `secret_token`
2. **Telegram ะทะฐะฟะพะผะธะฝะฐะตั** ััะพั ัะพะบะตะฝ
3. **ะัะธ ะบะฐะถะดะพะผ ะทะฐะฟัะพัะต** Telegram ะดะพะฑะฐะฒะปัะตั header `X-Telegram-Bot-Api-Secret-Token` ั ััะธะผ ัะพะบะตะฝะพะผ
4. **ะะฐั API ะฟัะพะฒะตััะตั**, ััะพ ัะพะบะตะฝ ะฒ header ัะพะฒะฟะฐะดะฐะตั ั ัะพะบะตะฝะพะผ ะฒ ะบะพะฝัะธะณััะฐัะธะธ
5. **ะัะปะธ ัะพะบะตะฝั ัะพะฒะฟะฐะดะฐัั** โ ะทะฐะฟัะพั ะพะฑัะฐะฑะฐััะฒะฐะตััั
6. **ะัะปะธ ะฝะต ัะพะฒะฟะฐะดะฐัั** โ ะฒะพะทะฒัะฐัะฐะตััั `401 Unauthorized`

---

## ๐ ะะพะด ะฟัะพะฒะตัะบะธ

ะะพั ะบะฐะบ ััะพ ัะตะฐะปะธะทะพะฒะฐะฝะพ ะฒ `TelegramEndpoints.cs`:

```csharp
// 1. ะงะธัะฐะตะผ ัะตะบัะตั ะธะท ะบะพะฝัะธะณััะฐัะธะธ (ะฒ ะฟะพััะดะบะต ะฟัะธะพัะธัะตัะฐ)
var secret = cfg["Bot:WebhookSecret"] ?? cfg["BOT__WEBHOOKSECRET"]
           ?? cfg["BOT__WEBHOOKSECRETTOKEN"] ?? cfg["TELEGRAM_WEBHOOK_SECRET"];

// 2. ะัะปะธ ัะตะบัะตั ะฝะฐัััะพะตะฝ, ะฟัะพะฒะตััะตะผ ะตะณะพ
if (!string.IsNullOrEmpty(secret))
{
    // 3. ะััะฐะตะผัั ะฟะพะปััะธัั header ะธะท ะทะฐะฟัะพัะฐ
    if (!request.Headers.TryGetValue("X-Telegram-Bot-Api-Secret-Token", out var header) 
        || header != secret)
    {
        // 4. ะัะปะธ header ะพััััััะฒัะตั ะธะปะธ ะฝะต ัะพะฒะฟะฐะดะฐะตั โ ะฒะพะทะฒัะฐัะฐะตะผ 401
        return Results.Unauthorized();
    }
}

// 5. ะัะปะธ ะฟัะพะฒะตัะบะฐ ะฟัะพัะปะฐ โ ะพะฑัะฐะฑะฐััะฒะฐะตะผ ะทะฐะฟัะพั
```

---

## ๐ ะัะบัะดะฐ ัะธัะฐะตััั ัะตะบัะตั

ะะพะด ะฟัะพะฒะตััะตั ัะตะบัะตั ะฒ ัะปะตะดัััะตะผ ะฟะพััะดะบะต ะฟัะธะพัะธัะตัะฐ:

1. **`Bot:WebhookSecret`** โ ะธะท `appsettings.json` ะธะปะธ `appsettings.Development.json`
   ```json
   {
     "Bot": {
       "WebhookSecret": "ะฒะฐั_ัะตะบัะตั"
     }
   }
   ```

2. **`BOT__WEBHOOKSECRET`** โ ะฟะตัะตะผะตะฝะฝะฐั ะพะบััะถะตะฝะธั (ะดะฒะพะนะฝะพะต ะฟะพะดัะตัะบะธะฒะฐะฝะธะต `__` = ะฒะปะพะถะตะฝะฝะพััั)
   ```powershell
   $env:BOT__WEBHOOKSECRET = "ะฒะฐั_ัะตะบัะตั"
   ```

3. **`BOT__WEBHOOKSECRETTOKEN`** โ ะฟะตัะตะผะตะฝะฝะฐั ะพะบััะถะตะฝะธั
   ```powershell
   $env:BOT__WEBHOOKSECRETTOKEN = "ะฒะฐั_ัะตะบัะตั"
   ```

4. **`TELEGRAM_WEBHOOK_SECRET`** โ ะฟะตัะตะผะตะฝะฝะฐั ะพะบััะถะตะฝะธั
   ```powershell
   $env:TELEGRAM_WEBHOOK_SECRET = "ะฒะฐั_ัะตะบัะตั"
   ```

**ะะฐะถะฝะพ:** ะัะปะธ ัะตะบัะตั ะฝะต ะฝะฐะนะดะตะฝ ะฝะธ ะฒ ะพะดะฝะพะผ ะธััะพัะฝะธะบะต, ะฟัะพะฒะตัะบะฐ **ะฝะต ะฒัะฟะพะปะฝัะตััั** (ะทะฐะฟัะพัั ะฟัะธะฝะธะผะฐัััั ะฑะตะท ะฟัะพะฒะตัะบะธ).

---

## โ ะงัะพ ะฝัะถะฝะพ ัะบะฐะทะฐัั ะฒ Postman

### Header ะดะปั ะทะฐะฟัะพัะฐ:

```
X-Telegram-Bot-Api-Secret-Token: 35309489b499f510d3c7e7034fef56ac04cb5d9d0288e053
```

### ะะพะปะฝัะน ะฟัะธะผะตั ะทะฐะฟัะพัะฐ:

**Method:** `POST`  
**URL:** `http://localhost:8080/telegram/webhook`

**Headers:**
```
Content-Type: application/json
X-Telegram-Bot-Api-Secret-Token: 35309489b499f510d3c7e7034fef56ac04cb5d9d0288e053
```

**Body (JSON):**
```json
{
  "update_id": 123456789,
  "message": {
    "message_id": 1,
    "from": {
      "id": 123456789,
      "is_bot": false,
      "first_name": "Test"
    },
    "chat": {
      "id": 123456789,
      "type": "private"
    },
    "date": 1704288000,
    "text": "/start"
  }
}
```

---

## ๐ฏ ะกัะตะฝะฐัะธะธ ัะฐะฑะพัั

### ะกัะตะฝะฐัะธะน 1: ะกะตะบัะตั ะฝะฐัััะพะตะฝ ะธ ัะพะฒะฟะฐะดะฐะตั โ

1. ะ ะบะพะฝัะธะณััะฐัะธะธ: `Bot:WebhookSecret = "35309489b499f510d3c7e7034fef56ac04cb5d9d0288e053"`
2. ะ header: `X-Telegram-Bot-Api-Secret-Token: 35309489b499f510d3c7e7034fef56ac04cb5d9d0288e053`
3. **ะะตะทัะปััะฐั:** `200 OK` โ ะทะฐะฟัะพั ะพะฑัะฐะฑะพัะฐะฝ

### ะกัะตะฝะฐัะธะน 2: ะกะตะบัะตั ะฝะฐัััะพะตะฝ, ะฝะพ ะฝะต ัะพะฒะฟะฐะดะฐะตั โ

1. ะ ะบะพะฝัะธะณััะฐัะธะธ: `Bot:WebhookSecret = "ะฟัะฐะฒะธะปัะฝัะน_ัะตะบัะตั"`
2. ะ header: `X-Telegram-Bot-Api-Secret-Token: ะฝะตะฟัะฐะฒะธะปัะฝัะน_ัะตะบัะตั`
3. **ะะตะทัะปััะฐั:** `401 Unauthorized`

### ะกัะตะฝะฐัะธะน 3: ะกะตะบัะตั ะฝะฐัััะพะตะฝ, ะฝะพ header ะพััััััะฒัะตั โ

1. ะ ะบะพะฝัะธะณััะฐัะธะธ: `Bot:WebhookSecret = "35309489b499f510d3c7e7034fef56ac04cb5d9d0288e053"`
2. ะ header: header ะพััััััะฒัะตั
3. **ะะตะทัะปััะฐั:** `401 Unauthorized`

### ะกัะตะฝะฐัะธะน 4: ะกะตะบัะตั ะฝะต ะฝะฐัััะพะตะฝ โ๏ธ

1. ะ ะบะพะฝัะธะณััะฐัะธะธ: ัะตะบัะตั ะพััััััะฒัะตั ะธะปะธ ะฟัััะพะน
2. ะ header: ะผะพะถะตั ะฑััั ะปัะฑะพะน ะธะปะธ ะพััััััะฒะพะฒะฐัั
3. **ะะตะทัะปััะฐั:** `200 OK` โ ะทะฐะฟัะพั ะพะฑัะฐะฑะพัะฐะฝ (ะฟัะพะฒะตัะบะฐ ะฝะต ะฒัะฟะพะปะฝัะตััั)

---

## ๐ง ะะฐัััะพะนะบะฐ ะดะปั ะปะพะบะฐะปัะฝะพะน ัะฐะทัะฐะฑะพัะบะธ

### ะะฐัะธะฐะฝั 1: ะงะตัะตะท appsettings.Development.json (ัะถะต ัะดะตะปะฐะฝะพ)

```json
{
  "Bot": {
    "WebhookSecret": "35309489b499f510d3c7e7034fef56ac04cb5d9d0288e053"
  }
}
```

### ะะฐัะธะฐะฝั 2: ะงะตัะตะท ะฟะตัะตะผะตะฝะฝัะต ะพะบััะถะตะฝะธั

ะ `launchSettings.json`:
```json
{
  "environmentVariables": {
    "TELEGRAM_WEBHOOK_SECRET": "35309489b499f510d3c7e7034fef56ac04cb5d9d0288e053"
  }
}
```

ะะปะธ ะฒ PowerShell ะฟะตัะตะด ะทะฐะฟััะบะพะผ:
```powershell
$env:TELEGRAM_WEBHOOK_SECRET = "35309489b499f510d3c7e7034fef56ac04cb5d9d0288e053"
dotnet run
```

---

## ๐จ ะะตะทะพะฟะฐัะฝะพััั

### โ ะฅะพัะพัะธะต ะฟัะฐะบัะธะบะธ:

1. **ะัะฟะพะปัะทัะนัะต ะดะปะธะฝะฝัะต ัะปััะฐะนะฝัะต ัััะพะบะธ** (ะผะธะฝะธะผัะผ 32 ัะธะผะฒะพะปะฐ)
2. **ะฅัะฐะฝะธัะต ัะตะบัะตัั ะฒ ะฟะตัะตะผะตะฝะฝัั ะพะบััะถะตะฝะธั** ะธะปะธ Secrets Manager (ะฝะต ะฒ ะบะพะดะต)
3. **ะัะฟะพะปัะทัะนัะต ัะฐะทะฝัะต ัะตะบัะตัั** ะดะปั dev/staging/production
4. **ะะต ะบะพะผะผะธัััะต ัะตะบัะตัั** ะฒ git

### โ ะะปะพัะธะต ะฟัะฐะบัะธะบะธ:

1. ะัะฟะพะปัะทะพะฒะฐัั ะบะพัะพัะบะธะต ะธะปะธ ะฟัะตะดัะบะฐะทัะตะผัะต ัะตะบัะตัั
2. ะฅัะฐะฝะธัั ัะตะบัะตัั ะฒ ะบะพะดะต ะธะปะธ ะฒ ะฟัะฑะปะธัะฝัั ัะตะฟะพะทะธัะพัะธัั
3. ะัะฟะพะปัะทะพะฒะฐัั ะพะดะธะฝ ัะตะบัะตั ะดะปั ะฒัะตั ะพะบััะถะตะฝะธะน

---

## ๐ ะะธะฐะณัะฐะผะผะฐ ะฟะพัะพะบะฐ

```
โโโโโโโโโโโโโโโ
โ   Telegram  โ
โ   Server    โ
โโโโโโโโฌโโโโโโโ
       โ POST /telegram/webhook
       โ Header: X-Telegram-Bot-Api-Secret-Token: <token>
       โ Body: { update }
       โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ   Your API Endpoint      โ
โ   /telegram/webhook      โ
โโโโโโโโฌโโโโโโโโโโโโโโโโโโโ
       โ
       โ 1. ะงะธัะฐะตั ัะตะบัะตั ะธะท ะบะพะฝัะธะณััะฐัะธะธ
       โ
       โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ   ะัะพะฒะตัะบะฐ ัะตะบัะตัะฐ       โ
โ   header == config?      โ
โโโโโโโโฌโโโโโโโโโโโโโโโโโโโ
       โ
       โโ ะะฐ โโโโโโโโโโโโโโโ
       โ                   โ
       โ                   โผ
       โ          โโโโโโโโโโโโโโโโโโโ
       โ          โ ะะฑัะฐะฑะพัะบะฐ updateโ
       โ          โ 200 OK          โ
       โ          โโโโโโโโโโโโโโโโโโโ
       โ
       โโ ะะตั โโโโโโโโโโโโโโ
                          โ
                          โผ
                 โโโโโโโโโโโโโโโโโโโ
                 โ 401 Unauthorizedโ
                 โโโโโโโโโโโโโโโโโโโ
```

---

## ๐งช ะขะตััะธัะพะฒะฐะฝะธะต ะฒ Postman

### ะจะฐะณ 1: ะะฐัััะพะนัะต header

1. ะัะบัะพะนัะต Postman
2. ะกะพะทะดะฐะนัะต ะฝะพะฒัะน `POST` ะทะฐะฟัะพั
3. URL: `http://localhost:8080/telegram/webhook`
4. ะะตัะตะนะดะธัะต ะฝะฐ ะฒะบะปะฐะดะบั **"Headers"**
5. ะะพะฑะฐะฒััะต header:
   - **Key:** `X-Telegram-Bot-Api-Secret-Token`
   - **Value:** `35309489b499f510d3c7e7034fef56ac04cb5d9d0288e053`

### ะจะฐะณ 2: ะะพะฑะฐะฒััะต Body

1. ะะตัะตะนะดะธัะต ะฝะฐ ะฒะบะปะฐะดะบั **"Body"**
2. ะัะฑะตัะธัะต **"raw"** โ **"JSON"**
3. ะััะฐะฒััะต JSON ั update:
```json
{
  "update_id": 123456789,
  "message": {
    "message_id": 1,
    "from": {
      "id": 123456789,
      "is_bot": false,
      "first_name": "Test"
    },
    "chat": {
      "id": 123456789,
      "type": "private"
    },
    "date": 1704288000,
    "text": "/start"
  }
}
```

### ะจะฐะณ 3: ะัะฟัะฐะฒััะต ะทะฐะฟัะพั

ะะฐะถะผะธัะต **"Send"**. ะะถะธะดะฐะตััั `200 OK`.

---

## ๐ ะะตัะตะทะฐะฟััะบ ะฟัะธะปะพะถะตะฝะธั

ะะพัะปะต ะธะทะผะตะฝะตะฝะธั `appsettings.Development.json` **ะฟะตัะตะทะฐะฟัััะธัะต ะฟัะธะปะพะถะตะฝะธะต**, ััะพะฑั ะธะทะผะตะฝะตะฝะธั ะฒัััะฟะธะปะธ ะฒ ัะธะปั.

